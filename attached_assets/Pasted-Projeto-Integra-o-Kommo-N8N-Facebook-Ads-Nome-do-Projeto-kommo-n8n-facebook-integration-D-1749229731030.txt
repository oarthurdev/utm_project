Projeto: IntegraÃ§Ã£o Kommo + N8N + Facebook Ads
Nome do Projeto: kommo-n8n-facebook-integration

ğŸ“‹ DescriÃ§Ã£o Geral
Crie um projeto completo que integre Kommo CRM, N8N e Facebook Offline Conversions API para:

âœ… Capturar automaticamente parÃ¢metros UTM de leads e armazenar no Kommo.
âœ… Disparar eventos offline para o Facebook Ads quando o lead muda de fase no funil do Kommo.
âœ… Automatizar fluxos via N8N.
âœ… Registrar logs e enviar alertas de falhas.

ğŸ¯ Objetivos Detalhados
1ï¸âƒ£ Captura de UTM no Kommo

Criar fluxos no N8N com Webhook:

Lead UTM Capture to Kommo

Quando um lead chega (via formulÃ¡rio, WhatsApp ou site):

Capturar os parÃ¢metros:

utm_source

utm_medium

utm_campaign

utm_content

utm_term

Gravar nos campos personalizados do lead no Kommo.

2ï¸âƒ£ Disparo de Eventos Offline para Facebook
Criar fluxos no N8N:

Offline Event Trigger - Atendimento

Offline Event Trigger - Visita

Offline Event Trigger - Lead Ganho

Offline Event Trigger - Lead Perdido (opcional).

Quando o lead muda de fase:

Disparar eventos offline para Facebook Offline Conversions API.

Enviar dados com hash SHA256:

Email

Telefone

Nome e Sobrenome

UTM capturada

Registrar logs de envio.

Alertar falhas (Slack ou e-mail).

3ï¸âƒ£ Logging e Alertas
Criar fluxo no N8N:

Logs & Alerts - Offline Events Facebook

Registrar logs de todos os envios e alertar em caso de falhas.

ğŸ“¡ Plataformas
N8N rodando online (servidor prÃ³prio ou cloud).

IntegraÃ§Ã£o com Kommo via API REST.

IntegraÃ§Ã£o com Facebook Offline Conversions API.

ğŸŒ Ambiente
100% Online.

NecessÃ¡rio comunicaÃ§Ã£o contÃ­nua entre sistemas.

â˜ï¸ Hosting
N8N preferencialmente em VPS (Docker) ou N8N Cloud.

Kommo e Facebook jÃ¡ sÃ£o SaaS.

ğŸ¨ Interface
NÃ£o requer interface para usuÃ¡rio final.

Apenas fluxos no N8N e logs.

ğŸ“Š SaÃ­das Esperadas
Campos UTM corretamente gravados no Kommo.

Eventos offline enviados e visÃ­veis no Facebook Ads Manager.

Logs de execuÃ§Ã£o no repositÃ³rio.

Alertas de falha automatizados.

ğŸ–¥ï¸ Exemplos de Fluxos N8N
Fornecer exemplos em JSON prontos:

1ï¸âƒ£ Fluxo de captura UTM â†’ Kommo:

{
  "name": "Lead UTM Capture to Kommo",
  "nodes": [
    {
      "parameters": {
        "path": "utm_capture",
        "method": "POST"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://{{KOMMO_ACCOUNT_DOMAIN}}/api/v4/leads/{{lead_id}}",
        "method": "PATCH",
        "responseFormat": "json",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "Bearer {{KOMMO_API_TOKEN}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "bodyParametersJson": " {\n  \"custom_fields_values\": [\n    { \"field_id\": \"utm_source_field_id\", \"values\": [{\"value\": \"{{$json[\"utm_source\"]}}\"}] },\n    { \"field_id\": \"utm_medium_field_id\", \"values\": [{\"value\": \"{{$json[\"utm_medium\"]}}\"}] },\n    { \"field_id\": \"utm_campaign_field_id\", \"values\": [{\"value\": \"{{$json[\"utm_campaign\"]}}\"}] },\n    { \"field_id\": \"utm_content_field_id\", \"values\": [{\"value\": \"{{$json[\"utm_content\"]}}\"}] },\n    { \"field_id\": \"utm_term_field_id\", \"values\": [{\"value\": \"{{$json[\"utm_term\"]}}\"}] }\n  ]\n}"
      },
      "name": "Update Lead in Kommo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [650, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Update Lead in Kommo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}

2ï¸âƒ£ Fluxo de envio de Evento Offline â†’ Facebook:

{
  "name": "Offline Event Trigger - Facebook",
  "nodes": [
    {
      "parameters": {
        "path": "facebook_offline_event",
        "method": "POST"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "const crypto = require('crypto');\n\nfunction hashSha256(value) {\n  return crypto.createHash('sha256').update(value).digest('hex');\n}\n\nreturn {\n  event_name: $json.event_name,\n  event_time: Math.floor(Date.now() / 1000),\n  user_data: {\n    em: [hashSha256($json.email)],\n    ph: [hashSha256($json.phone)],\n    fn: [hashSha256($json.first_name)],\n    ln: [hashSha256($json.last_name)]\n  },\n  custom_data: {\n    utm_source: $json.utm_source,\n    utm_medium: $json.utm_medium,\n    utm_campaign: $json.utm_campaign,\n    utm_content: $json.utm_content,\n    utm_term: $json.utm_term\n  }\n};"
      },
      "name": "Prepare Facebook Payload",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [550, 300]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://graph.facebook.com/v19.0/{{FACEBOOK_AD_ACCOUNT_ID}}/events",
        "method": "POST",
        "responseFormat": "json",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "Bearer {{FACEBOOK_ACCESS_TOKEN}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "bodyParametersJson": "{\n  \"data\": [\n    {{$json}}\n  ],\n  \"test_event_code\": \"{{TEST_EVENT_CODE}}\"\n}"
      },
      "name": "Send Event to Facebook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [850, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Prepare Facebook Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Facebook Payload": {
      "main": [
        [
          {
            "node": "Send Event to Facebook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}


ğŸ—‚ï¸ Estrutura de Pastas

kommo-n8n-facebook-integration/
â”œâ”€â”€ README.md
â”œâ”€â”€ .env.example
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ architecture_diagram.png
â”‚   â”œâ”€â”€ utm_fields_mapping.md
â”‚   â”œâ”€â”€ facebook_events_mapping.md
â”‚   â”œâ”€â”€ n8n_flows_description.md
â”œâ”€â”€ n8n-flows/
â”‚   â”œâ”€â”€ lead_utm_capture_mazi.json
â”‚   â”œâ”€â”€ lead_utm_capture_dicasa.json
â”‚   â”œâ”€â”€ offline_event_trigger_atendimento.json
â”‚   â”œâ”€â”€ offline_event_trigger_visita.json
â”‚   â”œâ”€â”€ offline_event_trigger_lead_ganho.json
â”‚   â”œâ”€â”€ offline_event_trigger_lead_perdido.json
â”‚   â”œâ”€â”€ logs_alerts_offline_events.json
â”œâ”€â”€ helpers/
â”‚   â”œâ”€â”€ hash_utils.js
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ kommo_fields_mapping.json
â”‚   â”œâ”€â”€ facebook_events_config.json
â””â”€â”€ logs/
    â”œâ”€â”€ offline_events.log
    â”œâ”€â”€ utm_capture.log

ğŸ“‹ README.md
Gerar um README.md completo conforme o exemplo fornecido no prompt anterior, com as seguintes seÃ§Ãµes:

âœ… Objetivo do projeto
âœ… VisÃ£o geral das plataformas
âœ… Funcionalidades detalhadas
âœ… Estrutura de pastas
âœ… VariÃ¡veis de ambiente (.env.example)
âœ… FunÃ§Ã£o de hash SHA256
âœ… Diagrama de arquitetura
âœ… Logs
âœ… Checklist de boas prÃ¡ticas
âœ… Idiomas utilizados

ğŸ” FunÃ§Ã£o de Hash SHA256
Gerar helper hash_utils.js com a funÃ§Ã£o:

const crypto = require('crypto');

function hashSha256(value) {
  if (!value) return '';
  return crypto.createHash('sha256').update(value.trim().toLowerCase()).digest('hex');
}

module.exports = {
  hashSha256
};

Pedidos finais ao Replit Agent:

âœ… Gerar todos os fluxos sugeridos no N8N em formato JSON.
âœ… Gerar funÃ§Ã£o de hash SHA256.
âœ… Gerar template .env.example com os placeholders adequados.
âœ… Gerar README.md completo.
âœ… Organizar o repositÃ³rio na estrutura fornecida.
âœ… Garantir que a documentaÃ§Ã£o final esteja clara e pronta para uso.